# Shrub https subscheme

draft-shrub.fr-shrub

## Abstract

This document defines the Shrub https subscheme. The Shrub https subscheme is designed to enable the creation of verifiable websites.

## Status of this memo

This document is a pre-draft which will be submited to the WHATWG in order to update [the Fetch Standard](https://fetch.spec.whatwg.org/).

## Copyright Notice

[![Creative Commons 0](https://i.creativecommons.org/p/zero/1.0/80x15.png)](https://creativecommons.org/publicdomain/zero/1.0/) To the extent possible under law, the editors have waived all copyright and related or neighboring rights to this work. In addition, as of May 19, 2019, the editors have made this specification available under the Open Web Foundation Agreement Version 1.0, which is available at <http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0>. Parts of this work may be from another specification document. If so, those parts are instead covered by the license of that specification document.

## Introduction

TODO

## Modifications of the Fetch Standard

In order to integrate the Shrub https subscheme, the following modifications of [the Fetch Standard](https://fetch.spec.whatwg.org/) are necessary.

### Modifications of [Section 4.6. HTTP-network fetch](https://fetch.spec.whatwg.org/#http-network-fetch)

In this section, the algorithm starts with:

> 1. Let _credentials_ be true if credentials flag is set, and false otherwise.
>
> 1. ...

A new step must be introduced in the algorithm described by this section:

1. Return the result of performing a Shrub-HTTP-network fetch using _request_, if all of the following is true:

   - _request’s_ current url’s scheme is "https"
   - _request’s_ current url’s host is a domain which has ".localhost" as suffix
   - _request’s_ current url’s port is 58273

1. Let _credentials_ be true if credentials flag is set, and false otherwise.

1. ...

### Creation of Section Shrub-HTTP-network fetch

This section should be inserted between [Section 4.6. HTTP-network fetch](https://fetch.spec.whatwg.org/#http-network-fetch) and [Section 4.7. CORS-preflight fetch](https://fetch.spec.whatwg.org/#cors-preflight-fetch).

The content of this section must be the following:

To perform a Shrub-HTTP-network fetch using _request_, run these steps:

1. If _request_'s method is `OPTIONS`, then run the following steps:
   1. Let _response_ be a new response whose status is `200 OK` and header list is [(`Allow`, `GET, HEAD, OPTIONS`)].
   1. Return _response_
1. If _request_'s method is not `GET` or `HEAD`, then return a new response which status is `405 Method Not Allowed`.

1. Let _domain_ be the _request’s_ current url’s host.

1. Let _L_ be the length of _domain_.

1. If _L_ is lesser or equal to 169, then return a [network error][net-error].

1. Let _HOST_ be the substring of _domain_ containing the codepoints between position 0 and _L_ - 170 inclusive.

1. Let _rootTag_ be the substring of _domain_ containing the codepoints between position _L_ - 62 and _L_ - 11 inclusive.

1. Let _TRoot_ be [the Base 32 decoding](https://tools.ietf.org/html/rfc4648#section-7) of _rootTag_ with alphabet "0123456789abcdefghijklmnopqrstuv" (0-9 a-v) and without padding.

1. If _TRoot_ is a decoding error, then return a [network error][net-error].

1. Let _key_ be the substring of _domain_ containing the codepoints between position _L_ - 115 and _L_ - 64 inclusive.

1. Let _K_ be [the Base 32 decoding](https://tools.ietf.org/html/rfc4648#section-7) of _key_ with alphabet "0123456789abcdefghijklmnopqrstuv" (0-9 a-v) and without padding.

1. If _K_ is a decoding error, then return a [network error][net-error].

1. Let _path_ be [the concatenate](https://infra.spec.whatwg.org/#string-concatenate) of the _request’s_ current url’s path with "/" as seperator.

1. Prepend "/" to _path_.

1. Let _Path_ be the UTF8 encoding of _path_.

1. Run these steps, but abort if the ongoing fetch is terminated:

   1. Let _well-known-request_ be a new request whose url is [the .Well-Known mapping][shrubbery-wellknown] of _HOST_ and (_TRoot_, _K_, _Path_), client is _request_'s client, origin is an opaque origin, initiator is "", destination is "", mode is "cors", cache mode is "no-store", service-workers mode is "none", credentials mode is "omit", redirect mode is "error", and referrer policy is "no-referrer".
   1. Let _well-known-response_ be the result of performing [an HTTP fetch](https://fetch.spec.whatwg.org/#http-fetch) with CORS flag set and _well-known-request_.
   1. Let _well-known-body_ be the body of _well-known-response_.
   1. If the status of _well-known-response_ is not `200 OK`, then error _well-known-body_'s stream with a TypeError and return a [network error][net-error].
   1. Let _Str_ be the byte stream generated by [_ShootStreaming_][shoot-streaming] using _TRoot_, _K_, _Path_ and _well-known-body_.
   1. Let _header-block-size_ be the Little-Endian decoding of the first 8 bytes read from _Str_.
   1. Let _header-block_ be the next _header-block-size_ bytes read from _Str_.
   1. Let _header-list_ be the list of headers obtained by decompressing _header-block_ with [HPACK](https://tools.ietf.org/html/rfc7541) with the size of the dynamic table fixed at 0.
   1. If _header-list_ is a decompression error, then error _well-known-body_'s stream with a TypeError and return a [network error][net-error].
   1. Let _response_ be a new response which header list is _header-list_.
   1. Set _response_'s status to be the value of the pseudo-header `:status` of _header-list_.
   1. If _request_'s method is `HEAD`, then error _well-known-body_'s stream with an "AbortError" DOMException, and return _response_.

1. If [aborted][aborted], then:

   1. Let _aborted_ be the termination’s aborted flag.
   1. If _aborted_ is set, then error _well-known-body_'s stream with an "AbortError" DOMException and return [an aborted network error](https://fetch.spec.whatwg.org/#concept-aborted-network-error).
   1. Error _well-known-body_'s stream with a TypeError.
   1. Return a [network error][net-error].

1. Let _highWaterMark_ be a non-negative, non-NaN number, chosen by the user agent.

1. Let _sizeAlgorithm_ be an algorithm that accepts a chunk object and returns a non-negative, non-NaN, non-infinite number, chosen by the user agent.

1. Let _pull_ be an action that resumes the ongoing fetch if it is suspended.

1. Let _cancel_ be an action that terminates the ongoing fetch with the aborted flag set.

1. Let _stream_ be the result of constructing a [ReadableStream](https://fetch.spec.whatwg.org/#concept-readablestream) object with _highWaterMark_, _sizeAlgorithm_, _pull_, and _cancel_.

1. Run these steps, but abort when the ongoing fetch is terminated:

   1. Set _response’s_ body to a new body whose stream is _stream_.
   1. If _response_ has a payload body length, then set _response’s_ body’s total bytes to that payload body length.
   1. Execute set response’s CSP list on _response_.
   1. If _response_ is not a network error and _request’s_ cache mode is not "no-store", update response in the HTTP cache for _request_.
   1. If credentials flag is set and the user agent is not configured to block cookies for _request_ (see section 7 of [COOKIES]), then run the "set-cookie-string" parsing algorithm (see section 5.2 of [COOKIES]) on the value of each header whose name is a byte-case-insensitive match for `Set-Cookie` in _response’s_ header list, if any, and _request’s_ current URL.

1. [If aborted][aborted], then:

   1. Let _aborted_ be the termination’s aborted flag.
   1. If _aborted_ is set, then set _response’s_ [aborted flag](https://fetch.spec.whatwg.org/#concept-response-aborted).
   1. Error _well-known-body_'s stream with an "AbortError" DOMException.
   1. Return _response_.

1. Run these steps [in parallel](https://html.spec.whatwg.org/multipage/infrastructure.html#in-parallel):

   1. Run these steps, but abort when the ongoing fetch is terminated:
      1. While true:
         1. If one or more bytes have been transmitted from _Str_, then:
            1. Let _bytes_ be the transmitted bytes.
            1. Increase _response’s_ body’s transmitted bytes with _bytes’_ length.
            1. Let _codings_ be the result of [extracting header list values](https://fetch.spec.whatwg.org/#extract-header-list-values) given `Content-Encoding` and _response’s_ header list.
            1. Set _bytes_ to the result of [handling content codings](https://fetch.spec.whatwg.org/#handle-content-codings) given codings and _bytes_.
            1. If _bytes_ is failure, then terminate the ongoing fetch.
            1. [Enqueue](https://fetch.spec.whatwg.org/#concept-enqueue-readablestream) a Uint8Array object wrapping an ArrayBuffer containing _bytes_ to _stream_. If that threw an exception, terminate the ongoing fetch, and error _stream_ with that exception.
            1. If _stream_ doesn’t need more data and _request’s_ synchronous flag is unset, ask the user agent to suspend the ongoing fetch.
         1. Otherwise, if the bytes transmission for _Str_ is done normally and _stream_ is readable, then close _stream_ and abort these in-parallel steps.
   1. [If aborted][aborted], then:
      1. Let _aborted_ be the termination’s aborted flag.
      1. If _aborted_ is set, then:
         1. Set _response’s_ aborted flag.
         1. If _stream_ is readable, error _stream_ with an "AbortError" DOMException.
      1. Otherwise, if _stream_ is readable, error _stream_ with a TypeError.
      1. Error _well-known-body_'s stream with an "AbortError" DOMException.

1. Return _response_.

## IANA Considerations

This document has no IANA actions.

## Security Considerations

TODO

## Privacy Considerations

TODO

[net-error]: https://fetch.spec.whatwg.org/#concept-network-error "network error"
[aborted]: https://infra.spec.whatwg.org/#if-aborted "aborted"
[shrubbery-wellknown]: shrubbery.md#the-well-known-uris-suffix-shrubbery "The .well-known URIs suffix 'shrubbery'"
[shoot-streaming]: shrubbery.md#shootstreaming-algorithm "ShootStreaming Algorithm"
